# Milvus Streaming 服务目录结构概览

## 概述

Milvus 的 Streaming 服务是一个分布式流处理系统，由两个核心组件构成：
- **StreamingCoord**：流处理协调器，负责管理和调度
- **StreamingNode**：流处理节点，负责实际的数据处理

## StreamingCoord 目录结构

### 1. client/ - 客户端实现
```
client/
├── assignment/          # Channel 分配客户端
│   ├── assignment_impl.go
│   ├── discoverer.go    # 服务发现
│   └── watcher.go       # 分配变更监听
├── broadcast/           # 广播客户端
│   └── broadcast_impl.go
└── client.go           # 客户端接口定义
```

### 2. server/ - 服务端实现

#### 2.1 balancer/ - 负载均衡器
```
balancer/
├── balancer.go         # 负载均衡器接口
├── balancer_impl.go    # 负载均衡器实现
├── channel/            # Channel 管理
│   ├── manager.go      # Channel 管理器
│   ├── pchannel.go     # 物理 Channel
│   ├── pchannel_stats.go  # Channel 统计
│   └── pchannel_view.go   # Channel 视图
└── policy/             # 负载均衡策略
    └── vchannelfair/   # 虚拟 Channel 公平策略
```

**核心功能**：
- Channel 的分配和负载均衡
- 节点间的负载调度
- 故障检测和恢复

#### 2.2 broadcaster/ - 广播服务
```
broadcaster/
├── broadcaster.go      # 广播器接口
├── broadcast_manager.go # 广播管理器
├── broadcast_task.go   # 广播任务
└── registry/          # 回调注册
    ├── ack_message_callback.go
    └── check_message_callback.go
```

**核心功能**：
- 消息广播管理
- 广播任务调度
- 回调机制支持

#### 2.3 service/ - 服务层
```
service/
├── assignment.go      # 分配服务
├── broadcast.go       # 广播服务
└── discover/         # 服务发现
    └── discover_server.go
```

## StreamingNode 目录结构

### 1. client/ - 客户端实现

#### 1.1 handler/ - 处理器客户端
```
handler/
├── assignment/        # 分配监听
│   └── watcher.go
├── consumer/         # 消费者
│   └── consumer_impl.go
├── producer/         # 生产者
│   └── producer_impl.go
└── registry/         # 注册中心
    └── wal_manager.go
```

#### 1.2 manager/ - 管理客户端
```
manager/
├── manager_client.go
└── manager_client_impl.go
```

### 2. server/ - 服务端实现

#### 2.1 wal/ - Write-Ahead Log 实现
```
wal/
├── wal.go            # WAL 接口定义
├── adaptor/          # 适配器层
│   ├── wal_adaptor.go
│   └── scanner_adaptor.go
├── interceptors/     # 拦截器链
│   ├── chain_interceptor.go
│   ├── lock/        # 锁拦截器
│   ├── redo/        # 重做日志拦截器
│   ├── shard/       # 分片拦截器
│   ├── timetick/    # 时间戳拦截器
│   └── txn/         # 事务拦截器
├── recovery/         # 恢复机制
│   ├── checkpoint.go
│   └── recovery_storage.go
└── utility/          # 工具类
    ├── message_heap.go
    └── reorder_buffer.go
```

**WAL 核心组件**：
- **适配器层**：支持多种存储后端（Kafka、Pulsar、RMQ）
- **拦截器链**：实现各种功能扩展
- **恢复机制**：支持故障恢复和检查点

#### 2.2 flusher/ - 数据刷写
```
flusher/
└── flusherimpl/
    ├── wal_flusher.go     # WAL 刷写器
    ├── msg_handler_impl.go # 消息处理
    ├── schema_manager.go   # Schema 管理
    └── pool.go            # 资源池
```

#### 2.3 walmanager/ - WAL 管理器
```
walmanager/
├── manager.go         # 管理器接口
├── manager_impl.go    # 管理器实现
├── wal_lifetime.go    # WAL 生命周期
└── wal_state.go      # WAL 状态管理
```

#### 2.4 service/ - 服务层
```
service/
├── handler.go        # 处理服务
│   ├── consumer/    # 消费服务
│   └── producer/    # 生产服务
└── manager.go       # 管理服务
```

## 核心概念映射

### Channel 体系
- **PChannel（物理 Channel）**：实际的消息队列 Topic
- **VChannel（虚拟 Channel）**：逻辑上的数据流分片
- **Assignment（分配）**：Channel 到节点的映射关系

### 服务交互
1. **StreamingCoord → StreamingNode**：下发 Channel 分配
2. **StreamingNode → StreamingCoord**：上报节点状态和指标
3. **Client → StreamingCoord**：查询 Channel 分配信息
4. **Client → StreamingNode**：数据读写操作

### 拦截器机制
拦截器链提供了可扩展的处理流程：
1. **Lock Interceptor**：并发控制
2. **Shard Interceptor**：分片管理
3. **TimeTick Interceptor**：时间戳同步
4. **Redo Interceptor**：重做日志
5. **Txn Interceptor**：事务支持

## 关键设计模式

1. **Manager 模式**：统一管理资源生命周期
2. **Interceptor Chain 模式**：可扩展的处理流程
3. **Watcher 模式**：监听配置和状态变更
4. **Registry 模式**：服务和组件注册
5. **Builder 模式**：复杂对象构建

## 依赖关系

```
StreamingCoord
  ├── Balancer (负载均衡)
  ├── Broadcaster (广播服务)
  └── Service Layer (服务层)

StreamingNode
  ├── WAL Manager (WAL管理)
  ├── Flusher (数据刷写)
  └── Service Layer (服务层)
      ├── Handler Service
      └── Manager Service
```